{% extends "base.html" %}

{% block content %}
<div class="container py-5">

    <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <h1 class="display-5 fw-bold"><i class="fas fa-microphone me-2"></i> Voice Assistant</h1>
        <p class="lead text-muted">Interact naturally with your AI companion in multiple languages</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="card-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <select name="target_language" id="target_language" class="form-select">
                        {% for lang, code in languages.items() %}
                            <option value="{{ code }}">{{ lang }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="message-container p-3 mb-4">
                    {% for message in messages %}
                        <div class="message {{ message.role|lower }}">
                            <div class="d-flex align-items-center mb-2">
                                {% if message.role == 'USER' %}
                                    <i class="fas fa-user-circle me-2" style="font-size: 1.5rem;"></i>
                                    <strong>You</strong>
                                {% else %}
                                    <i class="fas fa-robot me-2" style="font-size: 1.5rem;"></i>
                                    <strong>Assistant</strong>
                                {% endif %}
                            </div>
                            <p>{{ message.content }}</p>
                            {% if message.role == 'assistant' and message.translated %}
                                <div class="translated-text mt-2 p-2">
                                    <small class="d-block mb-1">Translated:</small>
                                    <p class="mb-0">{{ message.translated }}</p>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 empty-state">
                            <i class="fas fa-comment-dots"></i>
                            <p class="mt-3">Start a conversation with your AI assistant</p>
                        </div>
                    {% endfor %}
                </div>
                
                <form id="assistant-form" method="POST" action="{{ url_for('voice_assistant') }}">
                    <div class="input-group mb-3">
                        <button type="button" id="listen-btn" class="btn btn-modern">
                            <i class="fas fa-microphone me-2"></i> Listen
                        </button>
                        <input type="text" name="user_query" id="user_query" 
                               class="form-control form-control-modern" placeholder="Type your message...">
                        <button type="submit" name="send_message" class="btn btn-modern">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                
                <div id="audio-player" class="mt-3 text-center">
                    <audio controls autoplay id="response-audio">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Scroll to bottom of message container
        function scrollToBottom() {
            $('.message-container').animate({
                scrollTop: $('.message-container')[0].scrollHeight
            }, 300);
        }
        
        // Add pulse effect when listening
        $('#listen-btn').click(function() {
            $(this).addClass('pulse-effect');
            $.post('/voice_assistant', { listen: true }, function(data) {
                $('#user_query').val(data.command);
                $('#listen-btn').removeClass('pulse-effect');
                scrollToBottom();
            });
        });
        
        // Form submission
        $('#assistant-form').on('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                send_message: true,
                user_query: $('#user_query').val(),
                target_language: $('#target_language').val()
            };
            
            if (!formData.user_query.trim()) return;
            
            $.ajax({
                type: 'POST',
                url: '/voice_assistant',
                data: formData,
                beforeSend: function() {
                    // Add loading indicator
                    $('.empty-state').remove();
                    $('.message-container').append(`
                        <div class="message assistant">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-robot me-2" style="font-size: 1.5rem;"></i>
                                <strong>Assistant</strong>
                            </div>
                            <div class="loading-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    `);
                    scrollToBottom();
                },
                success: function(data) {
                    // Remove loading indicator
                    $('.message-container .loading-dots').parent().parent().remove();
                    
                    if (data.ai_response) {
                        // Add new messages
                        $('.message-container').append(`
                            <div class="message user">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-circle me-2" style="font-size: 1.5rem;"></i>
                                    <strong>You</strong>
                                </div>
                                <p>${formData.user_query}</p>
                            </div>
                            <div class="message assistant">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-robot me-2" style="font-size: 1.5rem;"></i>
                                    <strong>Assistant</strong>
                                </div>
                                <p>${data.ai_response}</p>
                                ${data.translated ? `
                                <div class="translated-text mt-2 p-2">
                                    <small class="d-block mb-1">Translated:</small>
                                    <p class="mb-0">${data.translated}</p>
                                </div>
                                ` : ''}
                            </div>
                        `);
                        
                        // Play audio if available
                        if (data.audio_b64) {
                            $('#audio-player').show();
                            $('#response-audio').html(`
                                <source src="data:audio/mp3;base64,${data.audio_b64}" type="audio/mp3">
                            `);
                            $('#response-audio')[0].load();
                            $('#response-audio')[0].play().catch(e => {
                                console.log("Autoplay blocked:", e);
                                $('#response-audio')[0].controls = true;
                            });
                        }
                        
                        // Clear input
                        $('#user_query').val('');
                        scrollToBottom();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    // Remove loading indicator
                    $('.message-container .loading-dots').parent().parent().remove();
                    
                    // Show error message
                    $('.message-container').append(`
                        <div class="message assistant">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2" style="font-size: 1.5rem;"></i>
                                <strong>Error</strong>
                            </div>
                            <p>Sorry, there was an error processing your request. Please try again.</p>
                        </div>
                    `);
                    scrollToBottom();
                }
            });
        });
        
        // Initial scroll to bottom
        scrollToBottom();
    });
</script>

<style>

    /* Modern buttons */
    .btn-modern {
        background: linear-gradient(135deg, #00b8ff 0%, #3a5a8c 100%);
        border: none;
        border-radius: 50px;
        padding: 10px 25px;
        color: #1a1a2e;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(48, 90, 140, 0.3);
        transition: all 0.3s ease;
    }

    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px #94e1ff;
        color: #1a1a2e;
    }

    /* Input styling */
    .form-control-modern {
        background: rgba(33, 37, 41, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        padding: 12px 20px;
        color: white;
        transition: all 0.3s ease;
    }

    .form-control-modern:focus {
        background: rgba(33, 37, 41, 0.85);
        border-color: #3a5a8c;
        box-shadow: 0 0 0 0.25rem rgba(0, 255, 136, 0.25);
        color: white;
    }

    /* Message container */
    .message-container {
        height: 400px;
        overflow-y: auto;
        border-radius: 15px;
        background: rgba(30, 30, 46, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Empty state */
    .empty-state {
        color: rgba(255, 255, 255, 0.5);
    }

    .empty-state i {
        font-size: 3rem;
    }

    /* Message bubbles */
    .message {
        position: relative;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 15px;
        max-width: 80%;
        animation: fadeIn 0.5s ease;
        color: white;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        background: linear-gradient(135deg, #3a5a8c 0%, #00b8ff 100%);
        margin-left: auto;
        border-bottom-right-radius: 5px;
    }

    .message.assistant {
        background: linear-gradient(135deg, #0062ff 0%, #3a5a8c 100%);
        margin-right: auto;
        border-bottom-left-radius: 5px;
    }

    .translated-text {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    /* Select dropdown styling */
    .form-select {
        background: rgba(255, 255, 255, 0.1) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23ffffff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") no-repeat;
        background-position: right 15px center;
        background-size: 12px;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        padding: 10px 35px 10px 15px;
        color: white;
        font-size: 1rem;
        cursor: pointer;
    }

    /* Audio player */
    #audio-player {
        display: none;
    }

    #audio-player audio {
        width: 100%;
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.1);
    }

    /* Loading animation */
    .loading-dots {
        display: inline-flex;
        align-items: center;
        height: 1rem;
    }
    
    .loading-dots span {
        width: 8px;
        height: 8px;
        margin: 0 2px;
        background-color: white;
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Pulse animation for listen button */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(0, 255, 136, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
    }

    .pulse-effect {
        animation: pulse 1.5s infinite;
    }
</style>
{% endblock %}